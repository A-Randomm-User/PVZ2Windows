<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial; margin: 20px; }
  button {
    margin: 5px; padding: 8px 14px; border: none;
    background: #0078d4; color: white; border-radius: 6px;
    cursor: pointer;
  }
  button:hover { background: #005fa3; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f5f5f5; }
  a { color: #0078d4; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>
</head>
<body>
<h2>选择要查看的软件表格</h2>

<div id="buttonContainer">正在加载 data.xlsx...</div>

<hr>
<div id="tableContainer">请点击上方按钮以加载数据</div>
<script>
// 支持旧 iOS 的 XMLHttpRequest 实现
function loadWorkbook(callback) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'test.xlsx', true);
  xhr.responseType = 'arraybuffer';

  xhr.onload = function() {
    if (xhr.status === 200) {
      var data = new Uint8Array(xhr.response);
      var workbook = XLSX.read(data, { type: 'array' });
      callback(null, workbook);
    } else {
      callback(new Error('无法加载 test.xlsx'));
    }
  };

  xhr.onerror = function() {
    callback(new Error('网络错误，无法加载 test.xlsx'));
  };

  xhr.send();
}

// 链接转换函数
function convertToLink(text) {
  if (typeof text !== 'string') return text;

  // itms-services 链接
  if (text.match(/^itms-services:\/\/\?action=download-manifest&url=/i)) {
    return '<a href="' + text + '">Download</a>';
  }

  // 普通 http(s) 或 ftp 链接
  if (text.match(/^(https?:\/\/|ftp:\/\/)/i)) {
    return '<a href="' + text + '" target="_blank">Download</a>';
  }

  return text;
}

// 显示工作表按钮
function init() {
  loadWorkbook(function(err, workbook) {
    var container = document.getElementById('buttonContainer');
    if (err) {
      container.innerHTML = '<p style="color:red;">❌ ' + err.message + '</p>';
      return;
    }

    container.innerHTML = '<b>检测到以下工作表：</b><br>';
    for (var i = 0; i < workbook.SheetNames.length; i++) {
      (function(sheetName) {
        var btn = document.createElement('button');
        btn.textContent = sheetName;
        btn.onclick = function() {
          showSheet(workbook, sheetName);
        };
        container.appendChild(btn);
      })(workbook.SheetNames[i]);
    }
  });
}

// 显示指定工作表内容
function showSheet(workbook, sheetName) {
  var sheet = workbook.Sheets[sheetName];
  if (!sheet) {
    document.getElementById('tableContainer').innerHTML =
      '<p style="color:red;">❌ 未找到工作表：' + sheetName + '</p>';
    return;
  }

  var rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  var html = '<h3>' + sheetName + '</h3><table>';
  for (var r = 0; r < rows.length; r++) {
    html += '<tr>';
    for (var c = 0; c < rows[r].length; c++) {
      var cellText = convertToLink(rows[r][c]);
      html += (r === 0 ? '<th>' : '<td>') + cellText + (r === 0 ? '</th>' : '</td>');
    }
    html += '</tr>';
  }
  html += '</table>';
  document.getElementById('tableContainer').innerHTML = html;
}

// 初始化
if (window.addEventListener) {
  window.addEventListener('load', init, false);
} else if (window.attachEvent) {
  window.attachEvent('onload', init);
} else {
  window.onload = init;
}
</script>

</body>
</html>